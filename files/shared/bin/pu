#!/bin/bash
set -eu -o pipefail

source $HOME/.secret

story="$1"
type="$2"

project_id=$(curl -s -X GET \
                  -H "X-TrackerToken: $PIVOTAL_TOKEN" \
                  "https://www.pivotaltracker.com/services/v5/projects" | \
                 jq '.[] | select(.name | contains("Security")) | .id')

story_id=$(
    curl -s -X GET \
         -H "X-TrackerToken: $PIVOTAL_TOKEN" \
         --data-urlencode "filter=\"${story}\"" \
         "https://www.pivotaltracker.com/services/v5/projects/${project_id}/stories" | \
        jq '.[].id')

# Create the task if no match is found.
if [[ "${story_id}" == "" ]]; then
    story_id=$(
        curl -X POST -s \
             -H "X-TrackerToken: $PIVOTAL_TOKEN" \
             -H "Content-Type: application/json" \
             -d "{\"name\":\"${story}\"}" \
             "https://www.pivotaltracker.com/services/v5/projects/${project_id}/stories" | \
            jq '.id')
fi

update_story() {
    curl -X PUT -s \
         -H "X-TrackerToken: $PIVOTAL_TOKEN" \
         -H "Content-Type: application/json" \
         -d "${1}" \
         "https://www.pivotaltracker.com/services/v5/projects/${project_id}/stories/${story_id}"
}

if [[ "${type}" == *new* ]]; then
    # Don't assign a point value.
    # Don't start it. Leave it in the icebox.
    echo
fi

if [[ "${type}" == *midweek* ]]; then
    # Set it as a zero pointer.
    update_story '{"estimate":0}'
fi

if [[ "${type}" == *start* ]]; then
    # Set it as started.
    update_story '{"current_state":"started"}'
fi

if [[ "${type}" == *done* ]]; then
    # Set it as delivered.
    update_story '{"current_state":"delivered"}'
fi
